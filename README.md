# ะะปะฐะฝ ะฟัะพะตะบัะฐ: HTTP Middleware
## 1. ะฆะตะปั ะฟัะพะตะบัะฐ

ะกะพะทะดะฐัั HTTP-ัะตัะฒะธั ะฝะฐ Go ั ะบะฐััะพะผะฝัะผะธ middleware, ะบะพัะพััะต:

ะะพะณะธัััั ะทะฐะฟัะพัั ะธ ะพัะฒะตัั.

ะัะพะฒะตัััั ะฐััะตะฝัะธัะธะบะฐัะธั ะฟะพ ัะพะบะตะฝั.

ะะณัะฐะฝะธัะธะฒะฐัั ัะบะพัะพััั ะทะฐะฟัะพัะพะฒ (rate limiting).

ะะฑัะฐะฑะฐััะฒะฐัั ะพัะธะฑะบะธ ะฒ ะตะดะธะฝะพะผ ัะพัะผะฐัะต JSON.

## ะขะตััั
```
go test ./... -v
```

# ะะปะฐะฝ ะฟะพ ะดะพะฑะฐะฒะปะตะฝะธั ะบ ะฟัะพะตะบัั ััะฝะบัะธะพะฝะฐะปะฐ
ะะพะฑะฐะฒะธัั Prometheus ะผะตััะธะบะธ (middleware ะดะปั ะผะตััะธะบ).

ะะฐัะฟัะตะดะตะปัะฝะฝัะน rate-limit ัะตัะตะท Redis ะธะปะธ ะฒะฝะตัะฝะตะต ัะตัะตะฝะธะต.

Structured logging (zerolog / zap).

Tracing (OpenTelemetry).

Graceful shutdown (context + server.Shutdown).

ASCII-ััะตะผะฐ, ะบะพัะพัะฐั ะฟะพะบะฐะทัะฒะฐะตั ะฟะพัะพะบ ะดะฐะฝะฝัั  

                   โโโโโโโโโโโโโโโโโโโโโโโโโ
                   โ       Client          โ
                   โ   (ะฑัะฐัะทะตั/curl)      โ
                   โโโโโโโโโโโโโฌโโโโโโโโโโโโ
                               โ HTTP-ะทะฐะฟัะพั
                               โผ
                   โโโโโโโโโโโโโโโโโโโโโโโโโ
                   โ  RecoveryMiddleware    โ
                   โ (ะปะพะฒะธั ะฟะฐะฝะธะบั, 500)    โ
                   โโโโโโโโโโโโโฌโโโโโโโโโโโโ
                               โ
                               โผ
                   โโโโโโโโโโโโโโโโโโโโโโโโโ
                   โ  LoggingMiddleware     โ
                   โ (ะปะพะณะธััะตั ะผะตัะพะด, ะฟััั, โ
                   โ ััะฐััั, ะฒัะตะผั)         โ
                   โโโโโโโโโโโโโฌโโโโโโโโโโโโ
                               โ
                               โผ
                   โโโโโโโโโโโโโโโโโโโโโโโโโ
                   โ   AuthMiddleware       โ
                   โ (ะฟัะพะฒะตััะตั ัะพะบะตะฝ ะฒ     โ
                   โ Authorization header)  โ
                   โโโโโโโโโโโโโฌโโโโโโโโโโโโ
                               โ
                               โผ
                   โโโโโโโโโโโโโโโโโโโโโโโโโ
                   โ RateLimitMiddleware    โ
                   โ (ะพะณัะฐะฝะธัะตะฝะธะต ัะฐััะพัั   โ
                   โ ะทะฐะฟัะพัะพะฒ ะฝะฐ IP)        โ
                   โโโโโโโโโโโโโฌโโโโโโโโโโโโ
                               โ
                               โผ
                   โโโโโโโโโโโโโโโโโโโโโโโโโ
                   โ      Handlers          โ
                   โ   /ping   /secure      โ
                   โโโโโโโโโโโโโฌโโโโโโโโโโโโ
                               โ
                               โผ
                   โโโโโโโโโโโโโโโโโโโโโโโโโ
                   โ     Response JSON      โ
                   โ {"message": "..."}     โ
                   โโโโโโโโโโโโโโโโโโโโโโโโโ


๐ ะฃ ะผะฐัััััะฐ /ping ัะตะฟะพัะบะฐ ะบะพัะพัะต โ ัะฐะผ ะฝะตั Auth ะธ RateLimit, ัะพะปัะบะพ Recovery + Logging.
๐ ะฃ /secure ะฟะพะดะบะปััะตะฝั ะฒัะต middleware: Recovery โ Logging โ Auth โ RateLimit โ Handler.

# HTTP Middleware ั Redis

ะญัะพั ะฟัะพะตะบั ัะพะดะตัะถะธั ะฝะฐะฑะพั ะฟะพะปะตะทะฝัั HTTP middleware ะฝะฐ Go, ะธัะฟะพะปัะทัััะธั Redis ะดะปั ัะตะฐะปะธะทะฐัะธะธ ัะฐะทะปะธัะฝัั ััะตะฝะฐัะธะตะฒ ะพะณัะฐะฝะธัะตะฝะธั ะทะฐะฟัะพัะพะฒ, ัะฟัะฐะฒะปะตะฝะธั ัะตััะธัะผะธ, ะพัะตัะตะดะตะน ะธ ะฐัะพะผะฐัะฝัั ะพะฟะตัะฐัะธะน.  

## ะกะพะดะตัะถะฐะฝะธะต

- [Simple Rate Limiting](#simple-rate-limiting)  
- [Sliding Window Rate Limiting](#sliding-window-rate-limiting)  
- [Distributed Lock Middleware](#distributed-lock-middleware)  
- [Page Counter Middleware](#page-counter-middleware)  
- [Queue Processing Middleware](#queue-processing-middleware)  
- [Session TTL Middleware](#session-ttl-middleware)  
- [Atomic State Update Middleware](#atomic-state-update-middleware)  

---

## Simple Rate Limiting

**ะะฐะบะตั:** `ratelimit`

**ะะฟะธัะฐะฝะธะต:**  
Middleware ะดะปั ะฟัะพััะพะณะพ ะพะณัะฐะฝะธัะตะฝะธั ะบะพะปะธัะตััะฒะฐ ะทะฐะฟัะพัะพะฒ ะฝะฐ ะพัะฝะพะฒะต IP ั ัะธะบัะธัะพะฒะฐะฝะฝัะผ ะพะบะฝะพะผ ะฒัะตะผะตะฝะธ.  

**ะัะธะฝัะธะฟ ัะฐะฑะพัั:**  
- Lua ัะบัะธะฟั ััะฐะฝะธั ัััััะธะบ ะทะฐะฟัะพัะพะฒ ะฒ Redis ั TTL.  
- ะัะปะธ ะบะพะปะธัะตััะฒะพ ะทะฐะฟัะพัะพะฒ ะทะฐ ะพะบะฝะพ ะฟัะตะฒััะฐะตั ะปะธะผะธั โ ะฒะพะทะฒัะฐัะฐะตััั `429 Too Many Requests`.  
- ะัะฟะพะปัะทัะตััั ะฟะพะดัะพะด "fail-open": ะฟัะธ ะพัะธะฑะบะฐั Redis ะทะฐะฟัะพั ะฟัะพะฟััะบะฐะตััั.  

**ะัะฟะพะปัะทะพะฒะฐะฝะธะต:**

```go
mux.Handle("/api", ratelimit.RateLimit(http.HandlerFunc(MyHandler)))
```
## Sliding Window Rate Limiting

**ะะฐะบะตั:** `slidingwindow`

**ะะฟะธัะฐะฝะธะต:**  
ะะณัะฐะฝะธัะตะฝะธะต ัะฐััะพัั ะทะฐะฟัะพัะพะฒ ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ ัะบะพะปัะทััะตะณะพ ะพะบะฝะฐ.

**ะัะธะฝัะธะฟ ัะฐะฑะพัั:**  
- ะ Redis ััะฐะฝะธััั ะพััะพััะธัะพะฒะฐะฝะฝะพะต ะผะฝะพะถะตััะฒะพ ะผะตัะพะบ ะฒัะตะผะตะฝะธ ะทะฐะฟัะพัะพะฒ.  
- ะฃะดะฐะปััััั ััะฐััะต ะทะฐะฟะธัะธ ะทะฐ ะฟัะตะดะตะปะฐะผะธ ะพะบะฝะฐ.  
- ะัะปะธ ะบะพะปะธัะตััะฒะพ ะทะฐะฟัะพัะพะฒ ะผะตะฝััะต ะปะธะผะธัะฐ โ ัะฐะทัะตััะฝ ะทะฐะฟัะพั.

**ะัะธะผะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั:**

```go
mux.Handle("/api", slidingwindow.SlidingWindow(5, 1000)(http.HandlerFunc(MyHandler)))
```

## Distributed Lock Middleware

**ะะฐะบะตั:** `distributedlock`

**ะะฟะธัะฐะฝะธะต:**  
Middleware ะดะปั ัะตะฐะปะธะทะฐัะธะธ ัะฐัะฟัะตะดะตะปัะฝะฝะพะน ะฑะปะพะบะธัะพะฒะบะธ ัะตัะตะท Redis. ะะพะปะตะทะฝะพ ะดะปั ะทะฐัะธัั ัะตััััะพะฒ ะพั ะพะดะฝะพะฒัะตะผะตะฝะฝะพะณะพ ะฒัะฟะพะปะฝะตะฝะธั (ะฝะฐะฟัะธะผะตั, ะทะฐะบะฐะทะพะฒ ะธะปะธ ะพะฑัะฐะฑะพัะบะธ ะฟะปะฐัะตะถะตะน).

**ะัะธะฝัะธะฟ ัะฐะฑะพัั:**  
- Lua ัะบัะธะฟั ัััะฐะฝะฐะฒะปะธะฒะฐะตั ะบะปัั ะฑะปะพะบะธัะพะฒะบะธ ั TTL, ะตัะปะธ ะพะฝ ะตัั ะฝะต ะทะฐะฝัั.  
- ะัะปะธ ะฑะปะพะบะธัะพะฒะบะฐ ะทะฐะฝััะฐ โ ะฒะพะทะฒัะฐัะฐะตััั `429 Too Many Requests`.

**ะัะฟะพะปัะทะพะฒะฐะฝะธะต:**

```go
mux.Handle("/order", distributedlock.RedisLockMiddleware("lock:order:123", 5000)(http.HandlerFunc(OrderHandler)))
```
## Page Counter Middleware

**ะะฐะบะตั:** `pagecounter`

**ะะฟะธัะฐะฝะธะต:**  
Middleware ะดะปั ะฟะพะดััััะฐ ะฟะพัะตัะตะฝะธะน ัััะฐะฝะธั ั ััะฐะฝะตะฝะธะตะผ ัััััะธะบะฐ ะฒ Redis.

**ะัะธะฝัะธะฟ ัะฐะฑะพัั:**  
- Lua ัะบัะธะฟั ะธะฝะบัะตะผะตะฝัะธััะตั ัััััะธะบ ะธ ัััะฐะฝะฐะฒะปะธะฒะฐะตั TTL ะดะปั ะฐะฒัะพะผะฐัะธัะตัะบะพะน ะพัะธััะบะธ.  
- ะขะตะบััะตะต ะทะฝะฐัะตะฝะธะต ัััััะธะบะฐ ะดะพะฑะฐะฒะปัะตััั ะฒ ะทะฐะณะพะปะพะฒะพะบ ะพัะฒะตัะฐ `X-Counter`.

**ะัะฟะพะปัะทะพะฒะฐะฝะธะต:**

```go
mux.Handle("/page", pagecounter.CounterMiddleware("counter:page_view", 60)(http.HandlerFunc(PageHandler)))
```

## Queue Processing Middleware

**ะะฐะบะตั:** `queue`

**ะะฟะธัะฐะฝะธะต:**  
Middleware ะดะปั ะพะฑัะฐะฑะพัะบะธ ะพัะตัะตะดะตะน ะทะฐะดะฐั ัะตัะตะท Redis. ะะตัะตะผะตัะฐะตั ัะปะตะผะตะฝั ะธะท ะธััะพะดะฝะพะน ะพัะตัะตะดะธ ะฒ ะพัะตัะตะดั ะพะฑัะฐะฑะพัะบะธ (in-progress) ั ะฟะพะผะพััั ะบะพะผะฐะฝะดั `RPOPLPUSH`.

**ะัะธะฝัะธะฟ ัะฐะฑะพัั:**  
- ะะตััะผ ัะปะตะผะตะฝั ั ะบะพะฝัะฐ ะธััะพะดะฝะพะน ะพัะตัะตะดะธ.  
- ะะพะฑะฐะฒะปัะตะผ ะตะณะพ ะฒ ะพัะตัะตะดั ะพะฑัะฐะฑะพัะบะธ.  
- ะะฐะณะพะปะพะฒะพะบ `X-Queue-Item` ัะพะดะตัะถะธั ัะตะบััะธะน ัะปะตะผะตะฝั.  
- ะัะปะธ ะพัะตัะตะดั ะฟัััะฐ โ ะฒะพะทะฒัะฐัะฐะตััั `204 No Content`.

**ะัะฟะพะปัะทะพะฒะฐะฝะธะต:**

```go
mux.Handle("/task", queue.QueueMiddleware("queue:tasks", "queue:processing")(http.HandlerFunc(TaskHandler)))
```
## Session TTL Middleware

**ะะฐะบะตั:** `session`

**ะะฟะธัะฐะฝะธะต:**  
Middleware ะดะปั ัะฟัะฐะฒะปะตะฝะธั ัะตััะธัะผะธ: ะฟัะพะดะปะตะฝะธะต TTL ะบะปััะฐ ะฒ Redis ะฟัะธ ะบะฐะถะดะพะผ ะทะฐะฟัะพัะต.

**ะัะธะฝัะธะฟ ัะฐะฑะพัั:**  
- ะะทะฒะปะตะบะฐะตั `session_id` ะธะท cookie.  
- Lua ัะบัะธะฟั ะฟัะพะฒะตััะตั ะฝะฐะปะธัะธะต ะบะปััะฐ ะธ ะฟัะพะดะปะตะฒะฐะตั TTL.  
- ะัะปะธ ัะตััะธั ะฝะต ะฝะฐะนะดะตะฝะฐ โ ะฒะพะทะฒัะฐัะฐะตััั `401 Unauthorized`.

**ะัะฟะพะปัะทะพะฒะฐะฝะธะต:**

```go
mux.Handle("/secure", session.SessionMiddleware(10)(http.HandlerFunc(SecureHandler)))
```



## Atomic State Update Middleware

**ะะฐะบะตั:** `stateupdate`

**ะะฟะธัะฐะฝะธะต:**  
Middleware ะดะปั ะฐัะพะผะฐัะฝะพะณะพ ะพะฑะฝะพะฒะปะตะฝะธั ะทะฝะฐัะตะฝะธั ะบะปััะฐ ะฒ Redis ะฟะพ ะฟัะธะฝัะธะฟั compare-and-set.

**ะัะธะฝัะธะฟ ัะฐะฑะพัั:**  
- Lua ัะบัะธะฟั ััะฐะฒะฝะธะฒะฐะตั ัะตะบััะตะต ะทะฝะฐัะตะฝะธะต ะบะปััะฐ ั ะพะถะธะดะฐะตะผัะผ.  
- ะัะปะธ ัะพะฒะฟะฐะดะฐะตั โ ัััะฐะฝะฐะฒะปะธะฒะฐะตั ะฝะพะฒะพะต ะทะฝะฐัะตะฝะธะต.  
- ะัะปะธ ะฝะต ัะพะฒะฟะฐะดะฐะตั โ ะฒะพะทะฒัะฐัะฐะตั `409 Conflict`.

**ะัะฟะพะปัะทะพะฒะฐะฝะธะต:**

```go
mux.Handle("/update", stateupdate.StateUpdateMiddleware("state:item123", "old", "new")(http.HandlerFunc(UpdateHandler)))
```

## ะะฐะบ ะทะฐะฟััะบะฐัั

1. ะฃััะฐะฝะพะฒะธัะต Redis ะปะพะบะฐะปัะฝะพ ะธะปะธ ะธัะฟะพะปัะทัะนัะต Docker:

```bash
docker run -p 6379:6379 redis
```
ะะฐัััะพะนัะต ะฟะพะดะบะปััะตะฝะธั ะบ Redis ะฒ ะบะฐะถะดะพะผ middleware.

ะะฐะฟัััะธัะต ัะตัะฒะตั:

```bash
go run main.go
```

## ะัะธะผะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั middleware ะดะปั ะทะฐัะธััะฝะฝะพะณะพ ะผะฐัััััะฐ

```go
mux.Handle("/secure", Chain(
    http.HandlerFunc(handlers.Secure),
    recovery.Recovery,   // ะปะพะฒะธะผ ะฟะฐะฝะธะบะธ ะธ ะฒะพะทะฒัะฐัะฐะตะผ 500
    logging.Logging,     // ััััะบัััะธัะพะฒะฐะฝะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต ะทะฐะฟัะพัะฐ
    metrics.Metrics,     // ัะฑะพั ะผะตััะธะบ ะดะปั Prometheus
    auth.Auth,           // ะฟัะพะฒะตัะบะฐ ะทะฐะณะพะปะพะฒะบะฐ Authorization
    ratelimit.RateLimit, // ะพะณัะฐะฝะธัะตะฝะธะต ัะฐััะพัั ะทะฐะฟัะพัะพะฒ ะฟะพ IP
))
```
ะะพััะฝะตะฝะธะต ะฟะพััะดะบะฐ middleware:

Recovery โ ะฟะตัะฒัะผ, ััะพะฑั ะฟะตัะตัะฒะฐััะฒะฐัั ะปัะฑัะต ะฟะฐะฝะธะบะธ ะธ ะฒะพะทะฒัะฐัะฐัั ะบะพััะตะบัะฝัะน HTTP-ะพัะฒะตั.

Logging โ ััะฐะทั ะฟะพัะปะต Recovery, ััะพะฑั ัะธะบัะธัะพะฒะฐัั ะฒัะต ะทะฐะฟัะพัั, ะฒะบะปััะฐั ัะต, ะณะดะต ะฟัะพะธะทะพัะปะฐ ะพัะธะฑะบะฐ.

Metrics โ ัะพะฑะธัะฐะตั ััะฐัะธััะธะบั ะฟะพ ะทะฐะฟัะพัะฐะผ.

Auth โ ะฟัะพะฒะตััะตั ะฐะฒัะพัะธะทะฐัะธั.

RateLimit โ ะพะณัะฐะฝะธัะธะฒะฐะตั ัะฐััะพัั ะทะฐะฟัะพัะพะฒ.

Handler (handlers.Secure) โ ะฒัะฟะพะปะฝัะตััั ะฒ ัะฐะผะพะผ ะบะพะฝัะต, ะบะพะณะดะฐ ะฒัะต ะฟัะพะฒะตัะบะธ ะธ ะพะฑัััะบะธ ะฟัะพะนะดะตะฝั.

## Structured Logging Middleware

**ะะฐะบะตั:** `logging`

**ะะฟะธัะฐะฝะธะต:**  
Middleware ะดะปั ััััะบัััะธัะพะฒะฐะฝะฝะพะณะพ ะปะพะณะธัะพะฒะฐะฝะธั HTTP-ะทะฐะฟัะพัะพะฒ ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ [`zerolog`](https://github.com/rs/zerolog). ะะพะทะฒะพะปัะตั ัะดะพะฑะฝะพ ัะพะฑะธัะฐัั ะปะพะณะธ ั ะฟะพะปัะผะธ `method`, `path`, `status`, `duration`, `user_id` ะธ ะดััะณะธะผะธ ะดะปั ะฟะพัะปะตะดัััะตะณะพ ะฐะฝะฐะปะธะทะฐ.
