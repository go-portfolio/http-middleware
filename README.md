# –ü–ª–∞–Ω –ø—Ä–æ–µ–∫—Ç–∞: HTTP Middleware
## 1. –¶–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞

–°–æ–∑–¥–∞—Ç—å HTTP-—Å–µ—Ä–≤–∏—Å –Ω–∞ Go —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ middleware, –∫–æ—Ç–æ—Ä—ã–µ:

–õ–æ–≥–∏—Ä—É—é—Ç –∑–∞–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã.

–ü—Ä–æ–≤–µ—Ä—è—é—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ —Ç–æ–∫–µ–Ω—É.

–û–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤ (rate limiting).

–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –æ—à–∏–±–∫–∏ –≤ –µ–¥–∏–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ JSON.

## –¢–µ—Å—Ç—ã
```
go test ./... -v
```

# –ü–ª–∞–Ω –ø–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é –∫ –ø—Ä–æ–µ–∫—Ç—É —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
–î–æ–±–∞–≤–∏—Ç—å Prometheus –º–µ—Ç—Ä–∏–∫–∏ (middleware –¥–ª—è –º–µ—Ç—Ä–∏–∫).

–†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π rate-limit —á–µ—Ä–µ–∑ Redis –∏–ª–∏ –≤–Ω–µ—à–Ω–µ–µ —Ä–µ—à–µ–Ω–∏–µ.

Structured logging (zerolog / zap).

Tracing (OpenTelemetry).

Graceful shutdown (context + server.Shutdown).

ASCII-—Å—Ö–µ–º–∞, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö  

                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ       Client          ‚îÇ
                   ‚îÇ   (–±—Ä–∞—É–∑–µ—Ä/curl)      ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ HTTP-–∑–∞–ø—Ä–æ—Å
                               ‚ñº
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ  RecoveryMiddleware    ‚îÇ
                   ‚îÇ (–ª–æ–≤–∏—Ç –ø–∞–Ω–∏–∫—É, 500)    ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
                               ‚ñº
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ  LoggingMiddleware     ‚îÇ
                   ‚îÇ (–ª–æ–≥–∏—Ä—É–µ—Ç –º–µ—Ç–æ–¥, –ø—É—Ç—å, ‚îÇ
                   ‚îÇ —Å—Ç–∞—Ç—É—Å, –≤—Ä–µ–º—è)         ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
                               ‚ñº
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ   AuthMiddleware       ‚îÇ
                   ‚îÇ (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω –≤     ‚îÇ
                   ‚îÇ Authorization header)  ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
                               ‚ñº
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ RateLimitMiddleware    ‚îÇ
                   ‚îÇ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã   ‚îÇ
                   ‚îÇ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ IP)        ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
                               ‚ñº
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ      Handlers          ‚îÇ
                   ‚îÇ   /ping   /secure      ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚îÇ
                               ‚ñº
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ     Response JSON      ‚îÇ
                   ‚îÇ {"message": "..."}     ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò


üëâ –£ –º–∞—Ä—à—Ä—É—Ç–∞ /ping —Ü–µ–ø–æ—á–∫–∞ –∫–æ—Ä–æ—á–µ ‚Äî —Ç–∞–º –Ω–µ—Ç Auth –∏ RateLimit, —Ç–æ–ª—å–∫–æ Recovery + Logging.
üëâ –£ /secure –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –≤—Å–µ middleware: Recovery ‚Üí Logging ‚Üí Auth ‚Üí RateLimit ‚Üí Handler.

# HTTP Middleware —Å Redis

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞–±–æ—Ä –ø–æ–ª–µ–∑–Ω—ã—Ö HTTP middleware –Ω–∞ Go, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö Redis –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤, —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏, –æ—á–µ—Ä–µ–¥–µ–π –∏ –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.  

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [Simple Rate Limiting](#simple-rate-limiting)  
- [Sliding Window Rate Limiting](#sliding-window-rate-limiting)  
- [Distributed Lock Middleware](#distributed-lock-middleware)  
- [Page Counter Middleware](#page-counter-middleware)  
- [Queue Processing Middleware](#queue-processing-middleware)  
- [Session TTL Middleware](#session-ttl-middleware)  
- [Atomic State Update Middleware](#atomic-state-update-middleware)  

---

## Simple Rate Limiting

**–ü–∞–∫–µ—Ç:** `ratelimit`

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
Middleware –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ IP —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –æ–∫–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.  

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**  
- Lua —Å–∫—Ä–∏–ø—Ç —Ö—Ä–∞–Ω–∏—Ç —Å—á—ë—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ Redis —Å TTL.  
- –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ –æ–∫–Ω–æ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `429 Too Many Requests`.  
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–¥—Ö–æ–¥ "fail-open": –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö Redis –∑–∞–ø—Ä–æ—Å –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è.  

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```go
mux.Handle("/api", ratelimit.RateLimit(http.HandlerFunc(MyHandler)))
```
## Sliding Window Rate Limiting

**–ü–∞–∫–µ—Ç:** `slidingwindow`

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–∫–æ–ª—å–∑—è—â–µ–≥–æ –æ–∫–Ω–∞.

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**  
- –í Redis —Ö—Ä–∞–Ω–∏—Ç—Å—è –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –º–µ—Ç–æ–∫ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø—Ä–æ—Å–æ–≤.  
- –£–¥–∞–ª—è—é—Ç—Å—è —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –æ–∫–Ω–∞.  
- –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –º–µ–Ω—å—à–µ –ª–∏–º–∏—Ç–∞ ‚Üí —Ä–∞–∑—Ä–µ—à—ë–Ω –∑–∞–ø—Ä–æ—Å.

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

```go
mux.Handle("/api", slidingwindow.SlidingWindow(5, 1000)(http.HandlerFunc(MyHandler)))
```

## Distributed Lock Middleware

**–ü–∞–∫–µ—Ç:** `distributedlock`

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
Middleware –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —á–µ—Ä–µ–∑ Redis. –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è –∑–∞—â–∏—Ç—ã —Ä–µ—Å—É—Ä—Å–æ–≤ –æ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–∫–∞–∑–æ–≤ –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π).

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**  
- Lua —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–ª—é—á –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å TTL, –µ—Å–ª–∏ –æ–Ω –µ—â—ë –Ω–µ –∑–∞–Ω—è—Ç.  
- –ï—Å–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–Ω—è—Ç–∞ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `429 Too Many Requests`.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```go
mux.Handle("/order", distributedlock.RedisLockMiddleware("lock:order:123", 5000)(http.HandlerFunc(OrderHandler)))
```
## Page Counter Middleware

**–ü–∞–∫–µ—Ç:** `pagecounter`

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
Middleware –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π —Å—Ç—Ä–∞–Ω–∏—Ü —Å —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—á—ë—Ç—á–∏–∫–∞ –≤ Redis.

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**  
- Lua —Å–∫—Ä–∏–ø—Ç –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç —Å—á—ë—Ç—á–∏–∫ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç TTL –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏.  
- –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç–≤–µ—Ç–∞ `X-Counter`.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```go
mux.Handle("/page", pagecounter.CounterMiddleware("counter:page_view", 60)(http.HandlerFunc(PageHandler)))
```

## Queue Processing Middleware

**–ü–∞–∫–µ—Ç:** `queue`

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
Middleware –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—á–µ—Ä–µ–¥–µ–π –∑–∞–¥–∞—á —á–µ—Ä–µ–∑ Redis. –ü–µ—Ä–µ–º–µ—â–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ –≤ –æ—á–µ—Ä–µ–¥—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ (in-progress) —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã `RPOPLPUSH`.

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**  
- –ë–µ—Ä—ë–º —ç–ª–µ–º–µ–Ω—Ç —Å –∫–æ–Ω—Ü–∞ –∏—Å—Ö–æ–¥–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏.  
- –î–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ –æ—á–µ—Ä–µ–¥—å –æ–±—Ä–∞–±–æ—Ç–∫–∏.  
- –ó–∞–≥–æ–ª–æ–≤–æ–∫ `X-Queue-Item` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—É—â–∏–π —ç–ª–µ–º–µ–Ω—Ç.  
- –ï—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `204 No Content`.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```go
mux.Handle("/task", queue.QueueMiddleware("queue:tasks", "queue:processing")(http.HandlerFunc(TaskHandler)))
```
## Session TTL Middleware

**–ü–∞–∫–µ—Ç:** `session`

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
Middleware –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏: –ø—Ä–æ–¥–ª–µ–Ω–∏–µ TTL –∫–ª—é—á–∞ –≤ Redis –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ.

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**  
- –ò–∑–≤–ª–µ–∫–∞–µ—Ç `session_id` –∏–∑ cookie.  
- Lua —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–∞ –∏ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç TTL.  
- –ï—Å–ª–∏ —Å–µ—Å—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `401 Unauthorized`.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```go
mux.Handle("/secure", session.SessionMiddleware(10)(http.HandlerFunc(SecureHandler)))
```



## Atomic State Update Middleware

**–ü–∞–∫–µ—Ç:** `stateupdate`

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
Middleware –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –∫–ª—é—á–∞ –≤ Redis –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É compare-and-set.

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**  
- Lua —Å–∫—Ä–∏–ø—Ç —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–ª—é—á–∞ —Å –æ–∂–∏–¥–∞–µ–º—ã–º.  
- –ï—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.  
- –ï—Å–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `409 Conflict`.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```go
mux.Handle("/update", stateupdate.StateUpdateMiddleware("state:item123", "old", "new")(http.HandlerFunc(UpdateHandler)))
```

## –ö–∞–∫ –∑–∞–ø—É—Å–∫–∞—Ç—å

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Redis –ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Docker:

```bash
docker run -p 6379:6379 redis
```
–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Redis –≤ –∫–∞–∂–¥–æ–º middleware.

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:

```bash
go run main.go
```

## –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è middleware –¥–ª—è –∑–∞—â–∏—â—ë–Ω–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞

```go
mux.Handle("/secure", Chain(
    http.HandlerFunc(handlers.Secure),
    recovery.Recovery,   // –ª–æ–≤–∏–º –ø–∞–Ω–∏–∫–∏ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 500
    logging.Logging,     // —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
    metrics.Metrics,     // —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –¥–ª—è Prometheus
    auth.Auth,           // –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ Authorization
    ratelimit.RateLimit, // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ IP
))
```
–ü–æ—è—Å–Ω–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ middleware:

Recovery ‚Äî –ø–µ—Ä–≤—ã–º, —á—Ç–æ–±—ã –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –ª—é–±—ã–µ –ø–∞–Ω–∏–∫–∏ –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π HTTP-–æ—Ç–≤–µ—Ç.

Logging ‚Äî —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ Recovery, —á—Ç–æ–±—ã —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã, –≤–∫–ª—é—á–∞—è —Ç–µ, –≥–¥–µ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.

Metrics ‚Äî —Å–æ–±–∏—Ä–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º.

Auth ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é.

RateLimit ‚Äî –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —á–∞—Å—Ç–æ—Ç—É –∑–∞–ø—Ä–æ—Å–æ–≤.

Handler (handlers.Secure) ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ, –∫–æ–≥–¥–∞ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –æ–±—ë—Ä—Ç–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã.

## Structured Logging Middleware

**–ü–∞–∫–µ—Ç:** `logging`

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
Middleware –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º [`zerolog`](https://github.com/rs/zerolog). –ü–æ–∑–≤–æ–ª—è–µ—Ç —É–¥–æ–±–Ω–æ —Å–æ–±–∏—Ä–∞—Ç—å –ª–æ–≥–∏ —Å –ø–æ–ª—è–º–∏ `method`, `path`, `status`, `duration`, `user_id` –∏ –¥—Ä—É–≥–∏–º–∏ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.

## –ú–µ—Ç—Ä–∏–∫–∏ –∏ Prometheus

–°–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ —Å –ø–æ–º–æ—â—å—é **OpenTelemetry** –∏ –æ—Ç–¥–∞—ë—Ç –∏—Ö –≤ —Ñ–æ—Ä–º–∞—Ç–µ **Prometheus**.

- –≠–Ω–¥–ø–æ–∏–Ω—Ç `/metrics` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Prometheus –¥–ª—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫:

```bash
curl http://localhost:8080/metrics

## –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ —á–µ—Ä–µ–∑ Prometheus

–°–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ —Å –ø–æ–º–æ—â—å—é OpenTelemetry –∏ –æ—Ç–¥–∞—ë—Ç –∏—Ö –Ω–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç `/metrics`.  

Prometheus –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–µ—Ä–≤–µ—Ä –ø–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ `prometheus.yml`

## –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –∏ –ø–æ—Ä—è–¥–æ–∫ middleware

–ú–µ—Ç—Ä–∏–∫–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `metrics.Metrics` middleware –∏ –æ—Ç–¥–∞—é—Ç—Å—è –Ω–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç `/metrics` –¥–ª—è Prometheus.

**–í–∞–∂–Ω–æ:** –ø–æ—Ä—è–¥–æ–∫ middleware –≤–ª–∏—è–µ—Ç –Ω–∞ –º–µ—Ç—Ä–∏–∫–∏:

- `metrics.Metrics` –¥–æ–ª–∂–µ–Ω —Ä–∞—Å–ø–æ–ª–∞–≥–∞—Ç—å—Å—è **–ø–æ—Å–ª–µ middleware**, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –º–µ–Ω—è—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `Recovery` –∏–ª–∏ `Logging`).  
- –¢–æ–≥–¥–∞ –≤ –º–µ—Ç—Ä–∏–∫–∞—Ö –±—É–¥—É—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –æ—à–∏–±–æ–∫.  
- Middleware, —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω—ã–µ **–ø–æ—Å–ª–µ `metrics.Metrics`**, –Ω–µ –±—É–¥—É—Ç —É—á–∏—Ç—ã–≤–∞—Ç—å—Å—è –≤ –º–µ—Ç—Ä–∏–∫–∞—Ö.  

–ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞:

```go
Chain(handler,
    recovery.Recovery,
    logging.Logging,
    metrics.Metrics,
)

## –ú–µ—Ç—Ä–∏–∫–∏ –ø–∞–Ω–∏–∫ (`Recovery` middleware)

- Middleware `Recovery` –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –ø–∞–Ω–∏–∫–∏ –≤ —Ö—ç–Ω–¥–ª–µ—Ä–∞—Ö, **–∫–æ—Ç–æ—Ä—ã–µ –æ–Ω–∞ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç**, –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç—É JSON —Å –æ—à–∏–±–∫–æ–π 500.  
- –î–ª—è –∫–∞–∂–¥–æ–π –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω–æ–π –ø–∞–Ω–∏–∫–∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –º–µ—Ç—Ä–∏–∫–∞ `recovery_panic_total`. –¢–∞–∫–∂–µ –≤–µ–¥—ë—Ç—Å—è —É—á—ë—Ç —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (`recovery_success_total`) –∏ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (`recovery_duration_seconds`).  
- **–í–∞–∂–Ω–æ:** –µ—Å–ª–∏ –≤–Ω—É—Ç—Ä–∏ —Ö—ç–Ω–¥–ª–µ—Ä–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π `recover`, –ø–∞–Ω–∏–∫–∞ **–Ω–µ –¥–æ–π–¥—ë—Ç –¥–æ middleware**, –∏ –º–µ—Ç—Ä–∏–∫–∞ `recovery_panic_total` **–Ω–µ —É–≤–µ–ª–∏—á–∏—Ç—Å—è**.  
- –ß—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤—Å–µ –ø–∞–Ω–∏–∫–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –æ–±–µ—Ä–Ω—É—Ç—å –≤–µ—Å—å `mux` –≤ `Recovery`.



